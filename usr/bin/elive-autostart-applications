#!/bin/bash
SOURCE="$0"
source /usr/lib/elive-tools/functions

main(){
    # pre {{{
    local file mode

    # }}}

    # Usage
    if [[ -z "${1}" ]] ; then
        echo -e "Usage: $(basename $BASH_SOURCE) [start|stop]"
        echo -e "Runs the XDG autostart applications selected by the user"
        exit 1
    fi

    mode="$1"

    case "$mode" in
        start)
            is_start=1
            ;;
        stop)
            is_stop=1
            ;;
        *)
            el_error "unknown mode for $SOURCE"
            ;;
    esac

    if [[ -n "$EROOT" ]] ; then
        # e16
        order_file="$HOME/.e16/startup-applications.list"
        e_version="0.16"
    else
        if [[ -x "$(which enlightenment)" ]] ; then
            e_version="$( enlightenment --version | grep "^Version: " | sed -e 's|^Version: ||g' | tail -1 )"
            case "$e_version" in
                0.17.*)
                    order_file="$HOME/.e/e17/applications/startup/.order"
                    ;;
                *)
                    el_error "unknown version of Enlightenment, ignoring selection of startup applications: '$E_VERSION' "
                    exit
                    ;;
            esac
        fi
    fi

    if ! [[ -e "$order_file" ]] ; then
        el_info "This tool requires a list of startup applications, located in '$order_file' "
        el_info "This file is a plain text list containing the full address of the .desktop files to run"
        el_info "example: /etc/xdg/autostart/elive-upgrader.desktop "
        exit 1

    fi

    # run them:
    if test -s "$order_file" ; then
        while read -ru 3 line
        do
            # skip already runs:
            if el_array_member_check "$line" "${already_run[@]}" ; then
                continue
            fi

            # skip comments
            if [[ "$line" = "#"* ]] ; then
                continue
            fi

            case "$line" in
                *.desktop|*.DESKTOP)
                    executable="$( grep "^Exec=" "$line" | sed -e 's|^Exec=||g' | tail -1 )"
                    if [[ -n "$executable" ]] ; then

                        if ((is_start)) ; then
                            # close other instances, just in case
                            killall $executable 2>/dev/null || true

                            el_debug "running $executable"
                            bash -c "$executable & disown"
                        fi
                        if ((is_stop)) ; then
                            el_debug "killing $executable"
                            killall "$executable"
                        fi
                    fi
                    ;;
                *)
                    cmd="$( echo "$line" | awk '{print $1}')"
                    if [[ -x "$( which "$cmd" )" ]] ; then
                        bash -c "$line & disown"
                    fi
                    ;;
            esac

            # append to the already run list:
            el_array_member_add "$line" "${already_run[@]}" ; already_run=("${_out[@]}")

        done 3<<< "$( cat "$order_file" )"
    fi


}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
