#!/bin/bash
SOURCE="$0"
source /usr/lib/elive-tools/functions
EL_REPORTS="1"
el_make_environment

main(){
    # pre {{{
    local file


    # }}}
    # e16
    if [[ -n "$EROOT" ]] ; then
        backgrounds_dir="$HOME/.e16/backgrounds"
    fi
    # E newer
    if [[ -n "$E_START" ]] ; then
        backgrounds_dir="$HOME/.e/e/backgrounds"

        E_VERSION="$( enlightenment --version | grep "^Version: " | sed -e 's|^Version: ||g' | tail -1 )"
        case "$E_VERSION" in
            0.17.*)
                backgrounds_dir="$HOME/.e/e17/backgrounds"
                ;;
            *)
                zenity --warning --text="Wallpapers configurator for newer version of Enlightenment is not yet implemented, try to do it manually from its configurations"
                backgrounds_dir="$HOME/.e/e/backgrounds"
                ;;
        esac
    fi

    mkdir -p "$backgrounds_dir"


    # add wallappers
    for file in "$@"
    do
        if ! [[ -s "$file" ]] ; then
            el_warning "No wallpaper file set: $file"
            continue
        fi

        # e16
        if [[ -n "$EROOT" ]] ; then
            name="$( echo "$file" | sed -e 's|^.*/||g' -e 's|\.*$||g' -e 's| |_|g' )"

            # add it
            if grep -qs "boot=live" /proc/cmdline ; then
                ln -s "$file" "$backgrounds_dir/$name"
            else
                cp -a "$file" "$backgrounds_dir/$name"
            fi
            file="$backgrounds_dir/$name"

            # set it
            eesh bg xset "$name" 0 0 0 "$file" 0 0 0 0 1024 1024 "" 0 0 0 0 0
            if eesh bg list | grep -qs "^${name}$" ; then
                for desk in $( seq $( eesh desk list | wc -l ) )
                do
                    eesh bg use "$name" $(( $desk - 1 ))
                done
            fi
        fi

        # e17
        if [[ -n "$E_START" ]] ; then
            enlightenment_remote -desktop-bg-add-set "$file"
        fi

    done

    # make a blurred version for the login manager
    if touch /var/tmp/wallpaper/wallpaper.jpg 2>/dev/null ; then
        convert "$file" -blur 0x30 -brightness-contrast -8x2 "/var/tmp/wallpaper/wallpaper.jpg"
    fi

}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
