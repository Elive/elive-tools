#!/bin/bash

# Lock system (good one) {{{
lockfile="/tmp/.$(basename $0)-${USER}.lock"

exit_ok(){
    rm -f "$lockfile"
}
exit_error(){
    rm -f "$lockfile"
}

if [[ -r "$lockfile" ]] ; then
    PROCCESS="$(cat $lockfile)"
else
    PROCCESS=" "
fi
if (ps up $PROCCESS) 1>/dev/null 2>&1 ; then
    el_error "$(basename $0) already running"
    exit
else
    echo $$ > "$lockfile"
fi

# traps needs to be after the lock verification, in order to not remove it when we are already running
trap "exit_ok" EXIT
trap "exit_error" 1 3 5 6 14 15 ERR TERM

# SET the lock file
echo "$$" > "$lockfile"


# end lock system }}}

main(){
    local pid

    # Usage
    if [[ -z "${1}" ]] ; then
        echo -e "Usage: $(basename $BASH_SOURCE) e16|e17"
        exit 1
    fi

    # play "breaking" sound
    if ! ((NOVOICE)) && ! ((SILENT)) && [[ -s "/usr/share/sounds/elive/glass-break.wav" ]] ; then
        hour="$(date +%k)"
        if [[ "${hour}" -lt "21" ]] && [[ "$hour" -gt "8" ]] ; then
            if [[ -x "$( which mpv )" ]] ; then
                ( mpv --no-video /usr/share/sounds/elive/glass-break.wav & )
            else
                if [[ -x "$( which mplayer )" ]] ; then
                    ( mplayer -cache-min 99 -cache-seek-min 99 -vc null -vo null -quiet -input nodefault-bindings -noconfig all  "/usr/share/sounds/elive/glass-break.wav" & )
                fi
            fi
        fi
    fi

    cd ~
    sync

    case "$@" in
        e16|E16)

            elive-autostart-applications stop

            killall -9 cairo-dock 2>/dev/null
            killall -9 conky 2>/dev/null
            # kill all startup-desktop processes
            for i in ~/.e16/New/* ~/.e16/Init/*
            do
                pid="$( ps ux | grep -Fv grep | grep -F "$i" | awk '{print $2}' )"
                if [[ -n "$pid" ]] ; then
                    kill -9 "$pid"
                fi
            done

            killall -9 starte16 efreetd  2>/dev/null
            killall -9 e16 2>/dev/null
            sync
            rm -fr ~/.xsession-errors

            elive-skel upgrade .config/audacious/playlists/1000.audpl
            elive-skel upgrade .config/cairo-dock
            elive-skel upgrade .config/gtk-3.0/settings.ini
            elive-skel upgrade .config/ulauncher
            elive-skel upgrade .conkyrc
            elive-skel upgrade .e16
            elive-skel upgrade .gtkrc-2.0.mine
            elive-skel upgrade .local/share/ulauncher
            elive-skel upgrade .xsettingsd
            elive-skel upgrade .Xdefaults

            sync
            ;;

        e17|E17)
            # E17+
            killall -s STOP enlightenment_start enlightenment ecomorph efreetd 2>/dev/null
            rm -fr ~/.e ~/.xsession-errors 1>/dev/null 2>&1
            rm -fr ~/.elementary ~/.config/elementary 1>/dev/null 2>&1
            sync
            killall -9 enlightenment_start enlightenment_system enlightenment ecomorph efreetd 2>/dev/null
            ;;
        *)
            el_error "unknown desktop to restart conf, example: $(basename $0) e16|e17"
            exit 1
            ;;
    esac

}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
