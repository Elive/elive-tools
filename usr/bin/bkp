#!/bin/bash
source /usr/lib/elive-tools/functions
el_make_environment
#TEXTDOMAIN=""
#export TEXTDOMAIN
set -e

do_work(){
    # this feature does a temporal copy of the directory for work from it,
    # everything is erased after the logout
    local dir tmpdir

    dir="$(pwd)"
    tmpdir="${bkpdir_works}/${namedir}"

    $SUDO_MODE rm -rf "${tmpdir}"
    mkdir -p "${tmpdir}"
    rmdir "${tmpdir}" # remove last dir in order to really-copy here

    cp -a "${dir}" "${tmpdir}"

    cd "${tmpdir}"

    echo -e "You are now in a safe place where modify your sources"
    echo -e "Your modifications will be merged or erased after you finish"
    el_explain 0 "Please logout from the shell for finish your working state"

    # entering in new shell
    $SHELL
    # go back
    cd "$target"

    if el_confirm "Do you want to run a meld with the original directory?" ; then
        if ! el_dependencies_check meld ; then
            el_dependencies_install meld
        fi
        meld "${tmpdir}" .
    fi

    if el_confirm "Delete the working state?" ; then
        $SUDO_MODE rm -rf "${tmpdir}"
    fi

}

do_purge_olds(){
    local others_list_num

    others_list_num="$( ls -1 "${bkpdir_backups}" 2>/dev/null | wc -l )"

    # remove backups
    if [[ -d "${bkpdir_backups}" ]] ; then
        $SUDO_MODE rm -rf "${bkpdir_backups}/%"*
    fi
    # remove working states
    if [[ -d "${bkpdir_works}" ]] ; then
        $SUDO_MODE rm -rf "${bkpdir_works}/%"*
    fi


    echo -e "${el_c_y}All backups and workstates removed${el_c_n}  [${others_list_num}]"
}


do_save(){
    local version others_list_num ref

    mkdir -p "${bkpdir_backups}"

    # show old existing backups
    others_list_num="$( ls -1 "${bkpdir_backups}" 2>/dev/null | grep "\.rdiff$" | wc -l )"
    if [[ "$others_list_num" -gt 5 ]] ; then
        echo -e "Warning: other backups found:"
        while read -ru 3 line
        do
           ref="${line//%//}"
           ref="${ref%.rdiff*}"
           if [[ -d "${ref}" ]] ; then
               echo -e " * ref: ${el_c_c}${ref}${el_c_n}"
           else
               echo -e " * ref: ${el_c_r2}${ref}${el_c_n}"
           fi

        done 3<<< "$( ls -1 "${bkpdir_backups}" | grep "\.rdiff$" )"

        echo -e ""
        echo -e "To remove single entry's just enter in the dir and run: ${el_c_g}$(basename $0) ${el_c_m}remove${el_c_n}"
        echo -e "You can remove ALL in one shot with: ${el_c_g}$(basename $0) ${el_c_y}purge${el_c_n}\n"
    fi

    if ! [[ -d "$bkpdir_id" ]] ; then
        mkdir -p "$bkpdir_id"
    fi

    echo -ne "Saving..."

    #      rsync -av --delete "${target}/" "${bkpdir_id}/"
    $SUDO_MODE rdiff-backup "${1}/" "${2}/"

    version="$( $SUDO_MODE rdiff-backup -l --parsable-output "$2" | wc -l )"

    echo -e "\r${el_c_g}Saved${el_c_n}  [${version}]"
    #echo -e "${el_c_g}Saved${el_c_n} $(du -hs ${2} | awk '{print $1}')"

}


do_get(){
    local version history_num

    if ! [[ -d "$bkpdir_id" ]] ; then
        echo -e "E: dir $bkpdir_id not exists, not backup saved yet ?"
        exit 1
    fi

    if [[ -n "$3" ]] ; then
        history_num="$3"
    else
        history_num="1"
    fi

    version="$( $SUDO_MODE rdiff-backup -l --parsable-output "$1" | awk '{print $1}' | tail -${history_num} | head -1 )"

    el_check_variables "version"

    $SUDO_MODE rm -rf "${1}.get"
    $SUDO_MODE rdiff-backup -r "$version" "${1}/" "${1}.get/"

    $SUDO_MODE rsync -av --delete "${1}.get/" "${2}/"

    cd "${2}"

}


do_list(){
    $SUDO_MODE rdiff-backup -l "${1}"
    echo ""
    $SUDO_MODE rdiff-backup --parsable-output -l "${1}"
}


do_meld(){
    local version history_num

    if ! [[ -d "$bkpdir_id" ]] ; then
        echo -e "E: dir $bkpdir_id not exists, not backup saved yet ?"
    fi

    if [[ -n "$3" ]] ; then
        history_num="$3"
    else
        history_num="1"
    fi

    version="$( $SUDO_MODE rdiff-backup -l --parsable-output "$1" | awk '{print $1}' | tail -${history_num} | head -1 )"

    el_check_variables "version"

    $SUDO_MODE rm -rf "${1}.differ"
    $SUDO_MODE rdiff-backup -r "$version" "${1}/" "${1}.differ/"

    echo -e "\n\n${el_c_y}###############################################################${el_c_n}\n"

    $SUDO_MODE meld "${1}.differ/" "${2}/"

    $SUDO_MODE rm -rf "${1}.differ"

    cd "${2}"
}


do_diff(){
    local version history_num

    if ! [[ -d "$bkpdir_id" ]] ; then
        echo -e "E: dir $bkpdir_id not exists, not backup saved yet ?"
    fi

    if [[ -n "$3" ]] ; then
        history_num="$3"
    else
        history_num="1"
    fi

    version="$( $SUDO_MODE rdiff-backup -l --parsable-output "$1" | awk '{print $1}' | tail -${history_num} | head -1 )"

    el_check_variables "version"

    $SUDO_MODE rm -rf "${1}.differ"
    $SUDO_MODE rdiff-backup -r "$version" "${1}/" "${1}.differ/"

    #echo -e "\n\n${el_c_y}###############################################################${el_c_n}\n"

    diff -Naur "${1}.differ/" "${2}/" | strings | sed -e "s|--- ${1}.differ|--- a|g" -e "s|+++ ${2}|+++ b|g" | colordiff

    echo -e "\n ${el_c_y}Total different files:${el_c_n} $( diff -Naur "${1}.differ/" "${2}/" | lsdiff | wc -l )"
    diff -Naur "${1}.differ/" "${2}/" | lsdiff | sed 's|^.*rdiff\.differ/||g'

    $SUDO_MODE rm -rf "${1}.differ"

    cd "${2}"
}


do_diff_reverse(){
    local version history_num

    if ! [[ -d "$bkpdir_id" ]] ; then
        echo -e "E: dir $bkpdir_id not exists, not backup saved yet ?"
    fi

    if [[ -n "$3" ]] ; then
        history_num="$3"
    else
        history_num="1"
    fi

    version="$( $SUDO_MODE rdiff-backup -l --parsable-output "$1" | awk '{print $1}' | tail -${history_num} | head -1 )"

    el_check_variables "version"

    $SUDO_MODE rm -rf "${1}.differ"
    $SUDO_MODE rdiff-backup -r "$version" "${1}/" "${1}.differ/"

    #echo -e "\n\n${el_c_y}###############################################################${el_c_n}\n"

    diff -Naur "${2}/" "${1}.differ/" | strings | sed -e "s|+++ ${1}.differ|+++ a|g" -e "s|--- ${2}|--- b|g" | colordiff

    echo -e "\n ${el_c_y}Total different files:${el_c_n} $( diff -Naur "${2}/" "${1}.differ/" | lsdiff | wc -l )"
    diff -Naur "${2}/" "${1}.differ/" | lsdiff | sed 's|^.*rdiff\.differ/||g'

    $SUDO_MODE rm -rf "${1}.differ"

    cd "${2}"
}


do_remove(){
    if [[ -d "${1}" ]] ; then
        $SUDO_MODE rm -rf "${1}"
        $SUDO_MODE rm -rf "${1}."*

        echo -e "${el_c_r}Removed dir ${el_c_y}${1}${el_c_n}"
    else
        echo -e "${el_c_r}E: ${el_c_n}Already removed ?"
    fi
}



main(){
    # pre {{{
    local tool namedir bkpdir_id target history_num

    tool="$(basename $0)"
    namedir="${PWD//\//%}"
    bkpdir_main="${HOME}/.${tool}"
    bkpdir_backups="${bkpdir_main}/backups"
    bkpdir_works="${bkpdir_main}/working"
    bkpdir_id="${bkpdir_backups}/${namedir}.rdiff"
    target="$PWD"

    # TODO: delete
    if [[ -d "${HOME}/.${tool}.backups" ]] ; then
        el_warning "you still having the old dir for backups, please remove it entirely: ${HOME}/.${tool}.backups"
    fi


    if [[ -L "$target" ]] ; then
        target="$( readlink -f "$target" )"
    fi

    # do we have automated access to sudo ? use sudo
    if el_check_sudo_automated ; then
	SUDO_MODE="sudo"
    else
	SUDO_MODE=""
    fi



    if ! el_dependencies_check "rsync,rdiff-backup,diff,colordiff" ; then
        el_dependencies_install "rsync,rdiff-backup,diffutils,colordiff"
    fi

    el_check_variables "tool,namedir,bkpdir_id,target"
    el_check_dirs      "${target}"


    # }}}

    case $1 in
        work|w|-w)
            do_work
            ;;
        save|s|-s|--save)
            do_save "${target}" "${bkpdir_id}"
            ;;
        get|g|-g|--get)
            history_num="$2"
            do_get "${bkpdir_id}" "${target}" "$history_num"
            ;;
        list|l|-l|--list)
            do_list "${bkpdir_id}"
            ;;
        diff)
            do_diff "${bkpdir_id}" "${target}" "${history_num}"
            ;;
        diff-reverse)
            do_diff_reverse "${bkpdir_id}" "${target}" "${history_num}"
            ;;
        meld)
            do_meld "${bkpdir_id}" "${target}" "${history_num}"
            ;;
        remove|-r)
            do_remove "${bkpdir_id}"
            ;;
        forget)
            el_error "did you mean remove?"
            exit 1
            ;;
        purge)
            do_purge_olds "${bkpdir_backups}"
            ;;
    esac



}

# Usage
if [[ -z "${1}" ]] ; then
    echo -e "Usage: $(basename $BASH_SOURCE) save | get {n} | list | diff {n} | meld {n} | remove | purge | work"
    echo -e "               extra options: diff-reverse {n}"
    echo -e "  where [n] is the number of previously historied backup"
    exit 1
fi



#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
