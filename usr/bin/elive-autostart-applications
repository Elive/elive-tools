#!/bin/bash
SOURCE="$0"
source /usr/lib/elive-tools/functions

main(){
    # pre {{{
    local file mode

    # }}}

    # Usage
    if [[ -z "${1}" ]] ; then
        echo -e "Usage: $(basename $BASH_SOURCE) [start|stop]"
        echo -e "Runs the XDG autostart applications selected by the user"
        exit 1
    fi

    mode="$1"

    case "$mode" in
        start)
            is_start=1
            ;;
        stop)
            is_stop=1
            ;;
        *)
            el_error "unknown mode for $SOURCE"
            ;;
    esac

    if [[ -n "$EROOT" ]] ; then
        # e16
        order_file="$HOME/.e16/startup-applications.list"
        e_version="0.16"
    else
        if [[ "$(which enlightenment)" ]] ; then
            e_version="$( enlightenment --version | grep "^Version: " | sed -e 's|^Version: ||g' | tail -1 )"
            case "$e_version" in
                0.17.*)
                    order_file="$HOME/.e/e17/applications/startup/.order"
                    ;;
                *)
                    el_error "unknown version of Enlightenment, ignoring selection of startup applications: '$E_VERSION' "
                    exit
                    ;;
            esac
        fi
    fi

    if ! [[ -e "$order_file" ]] ; then
        el_info "This tool requires a list of startup applications, located in '$order_file' "
        el_info "This file is a plain text list containing the full address of the .desktop files to run"
        el_info "example: /etc/xdg/autostart/elive-upgrader.desktop "
        exit 1

    fi

    # run them:
    if test -s "$order_file" ; then
        while read -ru 3 line
        do
            executable="$( grep "^Exec=" "$line" | sed -e 's|^Exec=||g' | tail -1 )"
            if [[ -n "$executable" ]] ; then

                if ((is_start)) ; then
                    el_debug "running $executable"
                    bash -c "$executable & disown"
                fi
                if ((is_stop)) ; then
                    el_debug "killing $executable"
                    killall "$executable"
                fi
            fi
        done 3<<< "$( cat "$order_file")"
    fi


}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
