#!/bin/bash
source /usr/lib/elive-tools/functions

main(){
    local result

    if ! el_dependencies_check curl ; then
        el_dependencies_install curl
    fi

    if ! el_verify_internet ; then
        el_error "no internet connection found"
        exit 1
    fi

    result="$( curl -A "Mozilla" -s http://www.showmyip.co.uk | grep "[[:digit:]].[[:digit:]].[[:digit:]].[[:digit:]]" | sed -e 's|^.*address:  <b>||g' -e 's|</b>.*$||g' -e 's|^.*<b>||g' | tail -1 )"
    # remove extra leading blank chars
    read -r result <<< "$result"

    # check and try from another if is wrong
    if [[ -z "$result" ]] || [[ "$result" = "192.168."* ]] || [[ "$result" = "10."* ]] || { dpkg --compare-versions "$result" ge "172.16" && dpkg --compare-versions "$result" le "172.32" ; } ; then
        result="$( curl -A "Mozilla" -s http://www.hostip.info | grep -i "IP address:.*[[:digit:]].[[:digit:]].[[:digit:]]" | sed -e 's|^.*address:  <b>||g' -e 's|</b>.*$||g' -e 's|^.*<b>||g' | tail -1 )"
        # remove extra leading blank chars
        read -r result <<< "$result"
    fi
    #curl -A "Mozilla" -s http://www.hostip.info | grep -i "IP address:" | sed -e 's|^.*address:  <b>||g' -e 's|</b>.*$||g' -e 's|^.*<b>||g'

    if [[ -z "$result" ]] || [[ "$result" = "192.168."* ]] || [[ "$result" = "10."* ]] || { dpkg --compare-versions "$result" ge "172.16" && dpkg --compare-versions "$result" le "172.32" ; } ; then
        el_error "Not correct external IP get"
        exit 1
    else
        echo "$result"
    fi

}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :
