#!/bin/bash
source /usr/lib/elive-tools/functions

. gettext.sh
export TEXTDOMAIN="elive-tools"

select_card_multiple(){
    local _id _description menu
    # list cards, per priority
    unset menu

    while read -ru 3 line
    do
        if [[ "$line" != *"]:"* ]] ; then
            continue
        fi

        _id="$( echo "$line" | sed -e 's|\]:.*$||g' -e 's|^.*\[||g' )"
        # remove extra leading blank chars
        read -r _id <<< "$_id"
        el_debug "id = '$_id'"

        _description="${line##*- }"
        # remove extra leading blank chars
        read -r _description <<< "$_description"
        el_debug "description = '$_description'"


        if [[ "$_id" ]] && [[ -n "$_description" ]] ; then

            # skip unwanted ones
            if ((is_smart_mode)) ; then
                # smart cards to skip: ThinkPad Console Audio Control
                if [[ "$_id" = "ThinkPadEC" ]] && [[ "$_description" = "ThinkPad Console Audio Control" ]] ; then
                    continue
                fi
            fi


            menu+=("$( echo "$_id" )")
            menu+=("$( echo "$_description" )")
        fi
    done 3<<< "$( cat /proc/asound/cards | psort -- -p "EWX" -p "PCH" -p "USB" -p "DAC" -p "Intel" -p "SB16" -p "CS4236" )"

    if [[ "${#menu[@]}" -eq 2 ]] ; then
        selection="$( echo "${menu[0]}" | head -1 )"
        is_auto_mode=1
    else
        selection="$( $guitool --list --width=400 --height=240 --column="Identifier" --column="$( eval_gettext "Description" )" --text="$( eval_gettext "Select the desired audio card that you want to use as default" )" "${menu[@]}" || echo cancel )"
    fi

    # remove extra leading blank chars
    read -r selection <<< "$selection"

    if [[ "${selection}" = "cancel" ]] ; then
        return 1
    fi
}

main(){
    # pre {{{
    local list_cards number_cards selection guitool line is_auto_mode is_quiet_mode

    if ! el_dependencies_check zenity ; then
        if ! el_dependencies_install zenity ; then
            exit 1
        fi
    fi

    # }}}

    # NOTE: this is a temporal tool, a lot of improvements will be made about this, so don't try to improve this one

    guitool=zenity

    list_cards="$(cat /proc/asound/cards | grep "^.*[[:digit:]].*\[.*\]:" | sed -e 's|\]:.*$||g' -e 's|^.*\[||g')"

    # if our first argument is the card name to use, change the list of cards to use this one
    # try to be smart determining cards that we know that they are valid
    while [[ -n "$1" ]]
    do
        if [[ "$1" = "--smart" ]] ; then
            is_smart_mode=1
            shift
        fi
        if [[ "$1" = "--auto" ]] ; then
            is_auto_mode=1
            shift
        fi
        if [[ "$1" = "--quiet" ]] ; then
            is_quiet_mode=1
            shift
        fi
        # if first argument is the name of the card that we want to use itself
        if [[ -n "$1" ]] && [[ "$1" != -* ]] ; then
            if echo "$list_cards" | grep -qs -- "$1" ; then
                list_cards="$1"
            fi
        fi
    done

    # no cards found
    if [[ -z "$list_cards" ]] ; then
        rm -f "${HOME}/.asoundrc"

        # reconfigure alsa.conf to defaults to correctly work, only if is not a number value
        if [[ "$UID" = 0 ]] ; then
            sed -i "s|^defaults.ctl.card.*$|defaults.ctl.card 0|g" /usr/share/alsa/alsa.conf
            sed -i "s|^defaults.pcm.card.*$|defaults.pcm.card 0|g" /usr/share/alsa/alsa.conf
        fi

        $guitool --warning --text="$( eval_gettext "No audio cards were detected in your system, we suggest you to try with a newer kernel version to see if can have newer drivers for it." )"

        exit
    fi

    number_cards="$( echo -e "$list_cards" | wc -l )"

    # only one card found
    if [[ "$number_cards" -lt "2" ]] ; then
        selection="$list_cards"
        # remove extra leading blank chars
        read -r selection <<< "$selection"

    else
        # more than one card found
        if ! ((is_auto_mode)) ; then
            if select_card_multiple ; then
                is_multiple_cards=1
            else
                if [[ -s "$HOME/.asoundrc" ]] ; then
                    exit 1
                else
                    unset is_multiple_cards
                    is_auto_mode=1
                fi
            fi
        fi

        if ((is_auto_mode)) ; then
            el_dependencies_check "psort"
            selection="$(echo "$list_cards" | tr ' ' '\n' | psort -- -p "^ThinkPadEC" -p "^NVidia" -p "midi" -p "MIDI" -p "^VX-5000" -p "^VX5000" -p "^Webcam" -p "^Dummy" -p "^HDMI" -p "system" | tac | head -1 )"
            # remove extra leading blank chars
            read -r selection <<< "$selection"
        fi

    fi

    # cleanup, new conf
    rm -f "${HOME}/.asoundrc"

    # user's conf
    if [[ -e "$DHOME/.shared-home" ]] ; then
        if $guitool --question --text="$( eval_gettext "Your home is shared with another system, if you try to configure your audio card it may not work in your other system, on such case you will need to remove the .asoundrc file later. Do you want to continue?" )" ; then
            echo "defaults.ctl.card ${selection}" >> "${HOME}/.asoundrc"
            echo "defaults.pcm.card ${selection}" >> "${HOME}/.asoundrc"
        fi
    else
        echo "defaults.ctl.card ${selection}" >> "${HOME}/.asoundrc"
        echo "defaults.pcm.card ${selection}" >> "${HOME}/.asoundrc"
    fi

    # reconfigure alsa.conf to our audio card
    if [[ "$UID" = 0 ]] && ! echo "$selection" | grep -qs "^[[:digit:]]*$" ; then
        sed -i "s|^defaults.ctl.card.*$|defaults.ctl.card ${selection}|g" /usr/share/alsa/alsa.conf
        sed -i "s|^defaults.pcm.card.*$|defaults.pcm.card ${selection}|g" /usr/share/alsa/alsa.conf
    fi

    # set microphone default
    if ! ((is_auto_mode)) && ! [[ -e "$DHOME/.shared-home" ]] ; then
        if ((is_multiple_cards)) ; then
            if ! $guitool --question --text="$( eval_gettext "Use the same audio card for your microphone?" )" ; then
                select_card_multiple

                cat >> "${HOME}/.asoundrc" << EOF

pcm.mic
{
    type hw
    card ${selection}
}

pcm.!default
{
    type asym
    playback.pcm
    {
        type plug
        slave.pcm "dmix"
    }
    capture.pcm
    {
        type plug
        slave.pcm "mic"
    }
}
EOF

            #else

                #local translated_message
                #translated_message="$( printf "$( eval_gettext "Using default card %s for your microphone" )" "$selection" )"

                #$guitool --info --text="$translated_message"
            fi

            # TODO: include a way to detect if mic is working, etc... maybe more easy to implement it on the C future mixer code
            #$guitool --info --text="$( eval_gettext "If you experience noise in your speakers, or your microphone doesn't capture anything, just play with the settings in your audio card mixer. Sometimes you need to enable the capture mode or set it to the microphone for make it working, and sometimes the microphone is repeated to your audio card giving you echo or noise, you can solve those problems trying different settings" )"

        fi

        if ! ((is_quiet_mode)) ; then
            $guitool --info --text="$( eval_gettext "Your audio card has been configured. To raise and decrease the volume use your keyboard hotkeys, if they don't works you can configure them in your Enlightenment hotkey preferences." )"
        fi

    fi
}

#
#  MAIN
#
main "$@"

# vim: set foldmethod=marker :

